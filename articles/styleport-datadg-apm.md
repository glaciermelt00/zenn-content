---
title: "Datadog APM で API レイテンシを 1/10 に改善した話"
emoji: "🙌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Datadog", "APM", "API", "レイテンシ"]
published: false
publication_name: "styleport"
---

# 背景

弊社では過去に Datadog APM にチャレンジしたものの、本番環境で障害を起こしてしまい、それ以降 APM の導入を見送ってきました。
今回、チーム内で改めてパフォーマンス計測の重要性に焦点が当てられたため、 Datadog APM の導入に再チャレンジしました。
それにより、パフォーマンスの可視化とボトルネックの特定が可能となり、API レイテンシを 1/10 に改善することができましたので、その経緯と成果を共有いたします。

# サマリー

- ECS 上の Rails アプリケーションに Datadog APM を導入
- Datadog APM の導入により、パフォーマンスの可視化とボトルネックの特定が可能に
- API レイテンシを 1/10 に改善
- 定期的なパフォーマンスレビューを実施し、継続的な改善活動を実施中

# 導入の経緯

Datadog APM を導入しようとしたきっかけは、以下の通りです。

- API パフォーマンスがどの程度のレベルか把握できていない状態なので、現状把握したい
- パフォーマンスに問題がある場合、ユーザーからのフィードバックを待たずにプロアクティブに改善したい

# 導入のプロセス

## 現状のインフラ構成と対象のアプリケーション

下図は、弊社 ROOV compass のインフラ構成図です。
メインのバックエンドアプリケーションは ECS Fargate 上で Ruby on Rails (RoR) で構築されています。

スモールスタート + 導入効果の最大化を図るため、まずは RoR アプリケーションに対して Datadog APM を導入することとしました。

![](https://storage.googleapis.com/zenn-user-upload/7d4db9b4f3dd-20250527.png)

## 導入のハードルとその解決策

Datadog APM の導入にあたっては、以下のようなハードルがありましたので、それぞれの解決策を講じました。

| 項目     | ハードル                             | 解決策                                                                            |
| -------- | ------------------------------------ | --------------------------------------------------------------------------------- |
| 技術面   | Datadog 完全未経験 / 社内未導入      | トライアル期間に Datadog 営業 / オンラインサポートを駆使して解決（特に ASM 周り） |
| 組織面   | Datadog 知見者ゼロ                   | サービスを絞ってスモールスタート（ ECS APM/ASM, ログにターゲティング）            |
| コスト面 | APM をフルで使うと利用料が跳ね上がる | APM サンプリングレートを最低限に設定して最適化                                    |

# ボトルネックの特定と改善例

ここでは、Datadog APM の導入によって可視化されたパフォーマンスの問題と、その改善例を紹介します。

## 導入によって可視化されたパフォーマンス

特定の API で `8 s 以上` かつ右肩上がりと、非常に高いレイテンシが発生していることが Datadog APM の導入によって可視化されました。

![](https://storage.googleapis.com/zenn-user-upload/3f610a9416a5-20250527.png)

## ボトルネックの特定

トレースのフレームグラフを確認すると、他のリスト取得系 API が大半を占めることがわかりました。

![](https://storage.googleapis.com/zenn-user-upload/64e76b19ccf7-20250527.png)

このリスト取得系 API へのリクエストはキャッシュされるため、キャッシュが存在しない状態のリクエストがボトルネックであると考えられました。

![](https://storage.googleapis.com/zenn-user-upload/a95083fd8e4e-20250527.png)

リスト取得系 API のロジックを調査したところ、以下のような問題があることがわかりました。

- DynamoDB から 企業 x ユースケースの組み合わせデータを取得し、それをメモリ上でフィルタリングしている
- 企業 x ユースケースを定義しているコンポーネントのカーディナリティが低く、時間と共に単調増加する懸念がある
- stage 環境では DynamoDB から取得時に 15 万件ヒットし、 7 ~ 10 s かかっている

## ボトルネックの改善

上記の調査結果を踏まえ、以下のような改善策を実施しました。

- フィルタリングを優先度に応じて、1 度だけ行うようにする
  - 優先度例: オブジェクト単位 / アクター単位 / 関数単位 / アクション単位 / ユースケース単位
  - オブジェクトのカーディナリティは極めて高く、フィルタリング効果が大きい -> パフォーマンス改善効果が大きい
  - 各種条件を変えてみたところ、概ねオブジェクトが指定されている -> 全体的に改善することが期待できる

上記の改善策により、 `8 s 以上` -> `0.8 s 未満` と、 API レイテンシを 1/10 に改善することができました。

![](https://storage.googleapis.com/zenn-user-upload/0d2f9d25d5a9-20250527.png)

# 継続的な改善と今後の展望

最後に、継続的な改善活動と、今後の展望について述べます。

## レイテンシのモニタリング

レイテンシ用ダッシュボードを作成し、レイテンシの状況を把握できるようにしています。
（レイテンシが全体的に不安定なため、アラームは未設置です）

![](https://storage.googleapis.com/zenn-user-upload/bbcda8970f03-20250527.png)

## 定期的なパフォーマンスレビュー

月に一度、バックエンドエンジニアとパフォーマンスレビューを実施し、以下のような内容を確認しています。

- API レイテンシの状況
- レイテンシのボトルネックの特定
- ボトルネックの改善策の検討
- チケットの作成とアサイン

![](https://storage.googleapis.com/zenn-user-upload/2195227f081f-20250527.png)

## Datadog サービスの更なる活用

Datadog には APM 以外にもさまざまなサービスがあります。
弊社では下記を活用しており、今後も更なる活用を検討しています。

- Synthetics
  - ブラウザテストや API テストを自動化し、 QA やリグレッションテストの効率化を図る
- Cloudcraft
  - インフラの構成を可視化し、リソースの全体像やネットワーク経路を把握する
