---
title: "複数アカウントで同じ VPC CIDR ブロックを使っている環境下で VPC peering を実現してみた"
emoji: "💭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "VPC", "Peering", "CIDR", "セカンダリ"]
published: false
publication_name: "styleport"
---

こんにちは、スタイルポートで SRE を担当しています。
今回は、複数アカウントで同じ VPC CIDR ブロックを使っている環境下で VPC peering を実現する方法についてお話しします。

# 背景

弊社の DiSIM 事業では、現在複数の AWS アカウントを使用しております。

現状では各アカウントで複数の EC2・RDS インスタンスをそれぞれ立てているのですが、 EC2・RDS インスタンスを集約してコスト削減を図りたいと考えています。

様々な事情を踏まえて、EC2 インスタンスは各アカウントで一つのインスタンスに集約し、 RDS インスタンスは新規アカウントのものに集約することとしました。

# 課題

EC2 インスタンスは問題なく集約できたものの、問題は RDS インスタンスの集約です。

しかし、各アカウントの EC2 インスタンスを立てている VPC では同じ CIDR ブロックを使用していることが判明しました。

イメージとしては、以下のような状態です。

| AWS アカウント | VPC CIDR ブロック |
| -------------- | ----------------- |
| アカウント A   | 16.8.0.0/16       |
| アカウント B   | 16.8.0.0/16       |
| アカウント C   | 16.16.0.0/16      |
| アカウント D   | 16.64.0.0/16      |

RDS を集約するためにはアカウント A ~ D で VPC を接続する (VPC peering) する必要がるのですが、 **アカウント A とアカウント B の VPC CIDR ブロックが同じであるため、VPC peering ができない** という問題が発生しました。

そのため、何らかの対策が必要となりました。

# 対策案

対策としては以下のような案が考えられました。

| No  | 対策案                                                                                                                      | メリット         | デメリット                                             |
| --- | --------------------------------------------------------------------------------------------------------------------------- | ---------------- | ------------------------------------------------------ |
| 1   | 新規の VPC を作成し、EC2 を載せ替える                                                                                       | 構成がシンプル   | 工数がかかり、複数デベ・物件に影響がまたがるリスクあり |
| 2   | VPC にセカンダリ CIDR ・サブネット上でネットワークインターフェイスを作成し EC2 にアタッチ・ OS ルーティングで DB に接続する | 構成が複雑で準備 | 既存構成に変更がなく、リスクが少ない                   |

今回はできるだけ既存の構成に変更を加えず、リスクを少なくすることを優先しました。
そのため、以下のような対策案 2 を採用しました。

# 対策内容

今回のキモは、 **DB 接続用 VPC を既存 VPC のセカンダリ CIDR とする** ことです。
具体的には、以下の手順で実施しました。

- ネットワーク
  - ネットワークの全体構成設計
  - VPC へセカンダリ CIDR を追加
  - セカンダリ CIDR のサブネットを用意
  - VPC Peering を作成
  - ルートテーブル設定
- EC2
  - サブネット上で DB 接続用ネットワークインターフェイス作成
  - ネットワークインターフェイスを EC2 に ホットアタッチ
  - EC2 OS ルーティング
- RDS
  - Security Group 設定

上記を実現すると、下図のようになります。

![](https://storage.googleapis.com/zenn-user-upload/097dc44d2b1c-20250606.png)

## 実施内容詳細

| カテゴリ     | 項目                                                     | 内容                                                                                                                                                                                                                                                       |
| ------------ | -------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ネットワーク | ネットワークの全体構成設計                               | VPC セカンダリ CIDR が既存 VPC の CIDR ブロックと重複しないように設計<br><br>アカウント A: 16.8.0.0/16 → 32.0.0.0/20<br>アカウント B: 16.8.0.0/16 → 32.0.16.0/20<br>アカウント C: 16.16.0.0/16 → 32.0.32.0/20<br>アカウント D: 16.64.0.0/16 → 32.0.48.0/20 |
|              | VPC へセカンダリ CIDR を追加                             | 各アカウントの VPC にセカンダリ CIDR を追加                                                                                                                                                                                                                |
|              | セカンダリ CIDR のサブネットを用意                       | AZ ごとに /24 程度のサブネットを用意                                                                                                                                                                                                                       |
|              | VPC Peering を作成                                       | RDS 集約用アカウントと各アカウントの VPC を接続                                                                                                                                                                                                            |
|              | ルートテーブル設定                                       | 既存ルートテーブルにルーティングとサブネットを追加                                                                                                                                                                                                         |
| EC2          | サブネット上で DB 接続用ネットワークインターフェイス作成 | サブネット上で DB 接続用のネットワークインターフェイスを作成                                                                                                                                                                                               |
|              | ネットワークインターフェイスを EC2 に ホットアタッチ     | ネットワークインターフェイスを EC2 にホットアタッチ                                                                                                                                                                                                        |
|              | EC2 OS ルーティング                                      | EC2 の OS ルーティングを設定                                                                                                                                                                                                                               |
| RDS          | Security Group 設定                                      | RDS の Security Group に、EC2 インスタンスが属する VPC の CIDR ブロックを許可                                                                                                                                                                              |

## まとめ

今回の対策により、複数アカウントで同じ VPC CIDR ブロックを使用している環境下でも VPC peering を実現することができました。
今後も AWS 環境でコスト最適化を推進していきたいと考えています。
